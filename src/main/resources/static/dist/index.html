<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikTok Live List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .live-list {
      list-style-type: none;
      padding: 0;
    }
    .live-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: flex;
      align-items: flex-start;
    }
    .live-item img {
      border-radius: 50%;
      margin-right: 10px;
    }
    .live-item div {
      flex: 1;
    }
    .actions {
      margin-bottom: 20px;
    }
    .actions input {
      margin-right: 10px;
    }
    .actions button {
      margin-right: 10px;
    }
    .room-list, .comment-list, .gift-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    .room-item, .comment-item, .gift-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto; /* 15% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be more or less, depending on screen size */
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
<h1>TikTok Live List</h1>
<div class="actions">
  <input type="text" id="newHostName" placeholder="Enter Host Name">
  <button onclick="createConnection()">Create New Connection</button>
  <button onclick="addListener()">Add Listener</button>
</div>
<ul class="live-list" id="liveList"></ul>

<!-- Modal -->
<div id="roomModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <ul class="room-list"></ul>
  </div>
</div>

<script>
  async function fetchLiveList() {
    try {
      const response = await fetch('http://localhost:8089/api/tiktok-live/connect/list');
      const data = await response.json();

      if (data.code === 200) {
        renderLiveList(data.data);
      } else {
        console.error('Failed to fetch data:', data.message);
      }
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }

  async function createConnection() {
    const hostName = document.getElementById('newHostName').value;
    if (!hostName) {
      alert('Please enter a host name.');
      return;
    }

    try {
      const response = await fetch('http://localhost:8089/api/tiktok-live/connect?hostName=' + hostName);
      const data = await response.json();
      if (data.code === 200) {
        alert('Connection created successfully.');
        fetchLiveList();
      } else {
        alert('Failed to create connection: ' + data.message);
      }
    } catch (error) {
      console.error('Error creating connection:', error);
    }
  }

  async function addListener() {
    const hostName = document.getElementById('newHostName').value;
    if (!hostName) {
      alert('Please enter a host name.');
      return;
    }

    try {
      const response = await fetch('http://localhost:8089/api/tiktok-live/create?hostName=' + hostName);
      const data = await response.json();
      if (data.code === 200) {
        alert('Listener added successfully.');
        fetchLiveList();
      } else {
        alert('Failed to add listener: ' + data.message);
      }
    } catch (error) {
      console.error('Error adding listener:', error);
    }
  }

  async function disconnectConnection(hostName) {
    try {
      const response = await fetch('http://localhost:8089/api/tiktok-live/disconnect?hostName=' + hostName);
      const data = await response.json();
      if (data.code === 200) {
        alert('Connection disconnected successfully.');
        fetchLiveList();
      } else {
        alert('Failed to disconnect connection: ' + data.message);
      }
    } catch (error) {
      console.error('Error disconnecting connection:', error);
    }
  }

  async function removeConnection(hostName) {
    try {
      const response = await fetch('http://localhost:8089/api/tiktok-live/remove?hostName=' + hostName);
      const data = await response.json();
      if (data.code === 200) {
        alert('Connection removed successfully.');
        fetchLiveList();
      } else {
        alert('Failed to remove connection: ' + data.message);
      }
    } catch (error) {
      console.error('Error removing connection:', error);
    }
  }

  async function fetchRoomList(hostName) {
    try {
      const response = await fetch('http://localhost:8089/api/tiktok-live/room/list?hostName=' + hostName);
      const data = await response.json();
      if (data.code === 200) {
        renderRoomList(data.data, hostName);
        showRoomModal(hostName);
      } else {
        alert('Failed to fetch room list: ' + data.message);
      }
    } catch (error) {
      console.error('Error fetching room list:', error);
    }
  }

  async function fetchRoomComments(roomId) {
    window.open(`comments.html?roomId=${roomId}`, '_blank');
  }

  async function fetchRoomGifts(roomId) {
    window.open(`gifts.html?roomId=${roomId}`, '_blank');
  }

  function renderRoomList(rooms, hostName) {
    const roomsContainer = document.querySelector('.room-list');
    roomsContainer.innerHTML = '';

    rooms.forEach(room => {
      const roomItem = document.createElement('li');
      roomItem.className = 'room-item';
      roomItem.innerHTML = `
                    <p>Room ID: ${room.roomId}</p>
                    <p>Host: ${room.hostName}</p>
                    <p>Start Time: ${new Date(room.startTime * 1000).toLocaleString()}</p>
                    <button onclick="fetchRoomComments('${room.roomId}')">View Comments</button>
                    <button onclick="fetchRoomGifts('${room.roomId}')">View Gifts</button>
                `;
      roomsContainer.appendChild(roomItem);
    });
  }

  function renderLiveList(liveList) {
    const liveListContainer = document.getElementById('liveList');
    liveListContainer.innerHTML = '';

    liveList.forEach(live => {
      const listItem = document.createElement('li');
      listItem.className = 'live-item';

      const hostImage = document.createElement('img');
      hostImage.src = live.hostPictureLink;
      hostImage.alt = live.hostName;
      hostImage.width = 50;
      hostImage.height = 50;

      const liveDetails = document.createElement('div');
      liveDetails.innerHTML = `
                    <h3>${live.title}</h3>
                    <p>Host: ${live.hostName} (${live.hostProfileName})</p>
                    <p>Room ID: ${live.roomId}</p>
 <!--                   <p>Viewers: ${live.viewersCount} | Total Viewers: ${live.totalViewersCount}</p>-->
 <!--                   <p>Likes: ${live.likesCount}</p>-->
                    <p>Start Time: ${new Date(live.startTime * 1000).toLocaleString()}</p>
<!--                    <p>Age Restricted: ${live.ageRestricted ? 'Yes' : 'No'}</p>-->
                    <p>Host ID: ${live.hostId}</p>
<!--                    <p>Host Following: ${live.hostFollowing}</p>-->
<!--                    <p>Host Followers: ${live.hostFollowers}</p>-->
                    <p>Language: ${live.language || 'N/A'}</p>
                    <p>Connection State: ${live.connectionState}</p>
                    <button onclick="disconnectConnection('${live.hostName}')">Disconnect</button>
                    <button onclick="removeConnection('${live.hostName}')">Remove</button>
                    <button onclick="fetchRoomList('${live.hostName}')">View Rooms</button>
                `;

      listItem.appendChild(hostImage);
      listItem.appendChild(liveDetails);
      liveListContainer.appendChild(listItem);
    });
  }

  function showRoomModal(hostName) {
    const modal = document.getElementById("roomModal");
    modal.style.display = "block";
    const closeBtn = document.querySelector(".close");
    closeBtn.onclick = function() {
      modal.style.display = "none";
    };
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
  }

  document.addEventListener('DOMContentLoaded', fetchLiveList);
</script>
</body>
</html>